#!/bin/bash
echo "Restoring layout.tsx..."
echo "J3VzZSBjbGllbnQnOwppbXBvcnQgewogIHVzZUhlYWRlclRpdGxlLAogIHdpdGhIZWFkZXJUaXRsZVByb3ZpZGVyLAp9IGZyb20gJ0AvY29tcG9uZW50cy9oZWFkZXItdGl0bGUtcHJvdmlkZXInOwppbXBvcnQgSGVhZGVyIGZyb20gJ0AvY29tcG9uZW50cy9sYXlvdXRzL2hlYWRlcic7CmltcG9ydCBTaWRlYmFyLCB7IFNpZGViYXJQcm9wcyB9IGZyb20gJ0AvY29tcG9uZW50cy9sYXlvdXRzL3NpZGViYXInOwppbXBvcnQgewogIHVzZVNpZGViYXJJdGVtcywKICB3aXRoU2lkZWJhckl0ZW1zUHJvdmlkZXIsCn0gZnJvbSAnQC9jb21wb25lbnRzL3NpZGViYXItaXRlbXMtcHJvdmlkZXInOwppbXBvcnQgeyBMZXNzb25JZEVudW0gfSBmcm9tICdAL2NvbnN0YW50cyc7CmltcG9ydCB1c2VMZXNzb25zSXRlbXMgZnJvbSAnQC9ob29rcy91c2VMZXNzb25zSXRlbXMnOwppbXBvcnQgeyB1c2VQYXRobmFtZSB9IGZyb20gJ0AvaTE4bi9yb3V0aW5nJzsKaW1wb3J0IHsgUGVuQm94IH0gZnJvbSAnbHVjaWRlLXJlYWN0JzsKaW1wb3J0IHsgcGFyc2VBc1N0cmluZ0VudW0sIHVzZVF1ZXJ5U3RhdGUgfSBmcm9tICdudXFzJzsKaW1wb3J0IFJlYWN0LCB7IHVzZUVmZmVjdCwgdXNlTWVtbyB9IGZyb20gJ3JlYWN0JzsKaW1wb3J0IHsgdXNlQXV0aCB9IGZyb20gJy4vX2NvbXBvbmVudHMvYXV0aC1wcm92aWRlcic7CmltcG9ydCB7IHdpdGhQcm90ZWN0ZWRSb3V0ZSB9IGZyb20gJy4vX2NvbXBvbmVudHMvcHJvdGVjdGVkLXJvdXRlJzsKCmNvbnN0IExheW91dCA9ICh7IGNoaWxkcmVuIH06IHsgY2hpbGRyZW46IFJlYWN0LlJlYWN0Tm9kZSB9KSA9PiB7CiAgY29uc3QgeyBpdGVtcywgdGl0bGUgfSA9IHVzZUFkbWluTGF5b3V0U2V0dXAoKTsKICBjb25zdCB7IGxvZ291dCwgdXNlciB9ID0gdXNlQXV0aCgpOwogIHJldHVybiAoCiAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBtaW4taC1zY3JlZW4iPgogICAgICA8U2lkZWJhcgogICAgICAgIG5hbWU9e3VzZXI/LmZpcnN0TmFtZSB8fCAnQWRtaW4nfQogICAgICAgIGVtYWlsPXt1c2VyPy5lbWFpbCB8fCAnYWRtaW5AZXhhbXBsZS5jb20nfQogICAgICAgIG9uTG9nb3V0PXtsb2dvdXR9CiAgICAgICAgaXRlbXM9e2l0ZW1zfQogICAgICAvPgogICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCB3LWZ1bGwgZmxleC1jb2wgYmctcHJpbWFyeS1mb3JlZ3JvdW5kIGRhcms6YmctdHJhbnNwYXJlbnQiPgogICAgICAgIDxIZWFkZXIgdGl0bGU9e3RpdGxlfSAvPgogICAgICAgIDxtYWluIGNsYXNzTmFtZT0iY29udGFpbmVyIGZsZXgtMSBvdmVyZmxvdy1oaWRkZW4gcHktNCBtZDpweS04Ij4KICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L21haW4+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgKTsKfTsKCmNvbnN0IHVzZUFkbWluTGF5b3V0U2V0dXAgPSAoKSA9PiB7CiAgY29uc3QgcGF0aG5hbWUgPSB1c2VQYXRobmFtZSgpOwogIGNvbnN0IGxlc3NvbnNJdGVtcyA9IHVzZUxlc3NvbnNJdGVtcygpOwogIGNvbnN0IHsgdXNlciB9ID0gdXNlQXV0aCgpOwogIGNvbnN0IGFkbWluUm9sZSA9IHVzZXI/LmFkbWluUm9sZSB8fCAndmlldyc7CiAgY29uc3QgW2xlc3Nvbl0gPSB1c2VRdWVyeVN0YXRlKAogICAgJ2xlc3NvbicsCiAgICBwYXJzZUFzU3RyaW5nRW51bTxMZXNzb25JZEVudW0+KE9iamVjdC52YWx1ZXMoTGVzc29uSWRFbnVtKSksCiAgKTsKICBjb25zdCBJVEVNUyA9IHVzZU1lbW8oCiAgICAoKSA9PiBbCiAgICAgIHsKICAgICAgICBocmVmOiAnL2FkbWluL2Ntcz9sZXNzb249UkVBRCcsCiAgICAgICAgbGFiZWw6ICdDTVMnLAogICAgICAgIGlzQWN0aXZlOiBwYXRobmFtZSA9PT0gJy9hZG1pbi9jbXMvJywKICAgICAgICB0eXBlOiAnZ3JvdXAnIGFzIGNvbnN0LAogICAgICAgIGlzSGlkZGVuOiBmYWxzZSwKICAgICAgICBjaGlsZHJlbjogbGVzc29uc0l0ZW1zCiAgICAgICAgICAubWFwKChpdGVtKSA9PiAoewogICAgICAgICAgICAuLi5pdGVtLAogICAgICAgICAgICBocmVmOiBgL2FkbWluL2Ntcz9sZXNzb249JHtpdGVtLmlkfWAsCiAgICAgICAgICAgIGlzQWN0aXZlOiBsZXNzb24gPT09IGl0ZW0uaWQsCiAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZSwKICAgICAgICAgIH0pKQogICAgICAgICAgLmNvbmNhdChbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBsYWJlbDogJ0xldmVscycsCiAgICAgICAgICAgICAgaHJlZjogJy9hZG1pbi9jbXMvbGV2ZWxzJywKICAgICAgICAgICAgICBpY29uOiBQZW5Cb3gsCiAgICAgICAgICAgICAgaXNBY3RpdmU6IHBhdGhuYW1lLnN0YXJ0c1dpdGgoJy9hZG1pbi9jbXMvbGV2ZWxzJyksCiAgICAgICAgICAgICAgaWQ6ICdsZXZlbHMnIGFzIExlc3NvbklkRW51bSwKICAgICAgICAgICAgICBpc0hpZGRlbjogZmFsc2UsCiAgICAgICAgICAgIH0sCiAgICAgICAgICBdKSwKICAgICAgfSwKICAgIF0sCiAgICBbcGF0aG5hbWUsIGxlc3NvbnNJdGVtcywgbGVzc29uXSwKICApOwogIGNvbnN0IFNJREVCQVJfSVRFTVM6IFNpZGViYXJQcm9wc1snaXRlbXMnXSAmIHsKICAgIGlzSGlkZGVuPzogYm9vbGVhbjsKICB9ID0gdXNlTWVtbygKICAgICgpID0+IFsKCiAgICAgIHsKICAgICAgICBocmVmOiAnL2FkbWluL3Rlc3RpbW9uaWFscycsCiAgICAgICAgbGFiZWw6ICdUZXN0aW1vbmlhbHMnLAogICAgICAgIGlzSGlkZGVuOiBmYWxzZSwKICAgICAgfSwKICAgICAgewogICAgICAgIGhyZWY6ICcvYWRtaW4vb3ZlcnZpZXcnLAogICAgICAgIGxhYmVsOiAnT3ZlcnZpZXcnLAogICAgICAgIGlzQWN0aXZlOiB0cnVlLAogICAgICAgIGlzSGlkZGVuOiBhZG1pblJvbGUgPT09ICd2aWV3JyB8fCBhZG1pblJvbGUgPT09ICdvcGVyYXRvcicsCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBocmVmOiAnL2FkbWluL3VzZXJzJywKICAgICAgICBsYWJlbDogJ1VzZXJzJywKICAgICAgICBpc0hpZGRlbjogYWRtaW5Sb2xlID09PSAndmlldycgfHwgYWRtaW5Sb2xlID09PSAnb3BlcmF0b3InLAogICAgICB9LAogICAgICB7CiAgICAgICAgaHJlZjogJy9hZG1pbi9vcmRlcnMnLAogICAgICAgIGxhYmVsOiAnT3JkZXJzJywKICAgICAgICBpc0hpZGRlbjogYWRtaW5Sb2xlICE9PSAnc3VwZXInICYmIGFkbWluUm9sZSAhPT0gJ21hbmFnZXInLAogICAgICB9LAogICAgICB7CiAgICAgICAgaHJlZjogJy9hZG1pbi9hZG1pbnMnLAogICAgICAgIGxhYmVsOiAnQWRtaW5zJywKICAgICAgICBpc0hpZGRlbjogYWRtaW5Sb2xlICE9PSAnc3VwZXInLAogICAgICB9LAogICAgICAuLi5JVEVNUywKICAgIF0sCiAgICBbSVRFTVMsIGFkbWluUm9sZV0sCiAgKTsKICBjb25zdCB7IHRpdGxlLCBzZXRUaXRsZSB9ID0gdXNlSGVhZGVyVGl0bGUoKTsKICBjb25zdCB7IGl0ZW1zLCBzZXRJdGVtcyB9ID0gdXNlU2lkZWJhckl0ZW1zKCk7CiAgdXNlRWZmZWN0KCgpID0+IHsKICAgIGNvbnN0IHZpc2libGVJdGVtcyA9IFNJREVCQVJfSVRFTVMuZmlsdGVyKAogICAgICAoaXRlbSkgPT4gIShpdGVtIGFzIHVua25vd24gYXMgeyBpc0hpZGRlbjogYm9vbGVhbiB9KS5pc0hpZGRlbiwKICAgICk7CiAgICBpZiAocGF0aG5hbWUgPT09ICcvYWRtaW4nIHx8IHBhdGhuYW1lID09PSAnL2FkbWluLycpIHsKICAgICAgc2V0SXRlbXModmlzaWJsZUl0ZW1zKTsKICAgICAgc2V0VGl0bGUoJ092ZXJ2aWV3Jyk7CiAgICB9IGVsc2UgewogICAgICBzZXRJdGVtcygKICAgICAgICB2aXNpYmxlSXRlbXM/Lm1hcCgoaXRlbSkgPT4gKHsKICAgICAgICAgIC4uLml0ZW0sCiAgICAgICAgICBpc0FjdGl2ZToKICAgICAgICAgICAgcGF0aG5hbWUgPT09ICcvJyAmJiBpdGVtLmhyZWYgPT09ICcvYWRtaW4vb3ZlcnZpZXcnCiAgICAgICAgICAgICAgPyB0cnVlCiAgICAgICAgICAgICAgOiBwYXRobmFtZS5zdGFydHNXaXRoKGl0ZW0uaHJlZiksCiAgICAgICAgfSkpLAogICAgICApOwoKICAgICAgY29uc3QgYWN0aXZlSXRlbSA9IHZpc2libGVJdGVtcz8uZmluZCgoaXRlbSkgPT4KICAgICAgICBwYXRobmFtZS5zdGFydHNXaXRoKGl0ZW0uaHJlZiksCiAgICAgICk7CgogICAgICBpZiAobGVzc29uIHx8IHBhdGhuYW1lLnN0YXJ0c1dpdGgoJy9hZG1pbi9jbXMnKSkgewogICAgICAgIHNldFRpdGxlKGxlc3NvbiA/IGxlc3NvbiA6ICdDTVMnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRUaXRsZShhY3RpdmVJdGVtID8gYWN0aXZlSXRlbS5sYWJlbCA6ICdPdmVydmlldycpOwogICAgICB9CiAgICB9CiAgfSwgW1NJREVCQVJfSVRFTVMsIGxlc3NvbiwgcGF0aG5hbWUsIHNldEl0ZW1zLCBzZXRUaXRsZV0pOwogIHJldHVybiB7IGl0ZW1zLCB0aXRsZSB9Owp9OwoKZXhwb3J0IGRlZmF1bHQgd2l0aFByb3RlY3RlZFJvdXRlKAogIHdpdGhTaWRlYmFySXRlbXNQcm92aWRlcih3aXRoSGVhZGVyVGl0bGVQcm92aWRlcihMYXlvdXQpKSwKKTsK" | base64 -d > /var/www/englishom/frontend/admin-englishom/src/app/[locale]/admin/\(protected\)/layout.tsx

echo "Creating Level Payload..."
echo "eyJ0aXRsZUFyIjoiTGV2ZWwgMSIsInRpdGxlRW4iOiJMZXZlbCAxIiwiZGVzY3JpcHRpb25BciI6IkRlc2MiLCJkZXNjcmlwdGlvbkVuIjoiRGVzYyIsInByaWNlIjoxMDAsImlzQXZhaWxhYmxlIjp0cnVlLCJsZXZlbF9uYW1lIjoiQTEifQ==" | base64 -d > /tmp/level_payload.json

echo "Creating Level via API..."
curl -v -X POST https://api.englishom.com/api/courses/admin -H "Content-Type: application/json" -d @/tmp/level_payload.json

echo "Rebuilding Admin..."
cd /var/www/englishom/frontend/admin-englishom
rm -rf .next
npm run build
pm2 restart admin-englishom
echo "Done!"
